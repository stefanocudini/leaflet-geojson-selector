/* 
 * Leaflet GeoJSON Selector v0.1.7 - 2015-07-13 
 * 
 * Copyright 2015 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * http://labs.easyblog.it/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demo: 
 * http://labs.easyblog.it/maps/leaflet-geojson-selector/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-geojson-selector.git 
 * 
 */
(function(){L.Control.GeoJSONSelector=L.Control.extend({includes:L.Mixin.Events,options:{collapsed:!1,position:"bottomleft",listLabel:"properties.name",listSortBy:null,listItemBuild:null,activeListFromLayer:!0,activeEventList:"click",activeEventLayer:"mouseover",activeClass:"active",activeStyle:{color:"#00f",fillColor:"#fa0",weight:1,opacity:1,fillOpacity:.6},style:{color:"#00f",fillColor:"#08f",weight:1,opacity:1,fillOpacity:.4}},initialize:function(a,b){var c=L.Util.setOptions(this,b||{});this.options.listSortBy=this.options.listSortBy||this.options.listLabel,this.options.listItemBuild&&(this._itemBuild=this.options.listItemBuild),this._layer=a,console.log(c)},onAdd:function(a){this._map=a;var b=L.DomUtil.create("div","geojson-list");return this._container=b,this._list=L.DomUtil.create("div","geojson-list-group",b),this._initToggle(),this._updateList(),L.DomEvent.on(b,"mouseover",function(b){a.scrollWheelZoom.disable()}).on(b,"mouseout",function(b){a.scrollWheelZoom.enable()}),a.whenReady(function(c){b.style.height=a.getSize().y+"px"}),b},onRemove:function(a){a.off("moveend",this._updateList,this)},reload:function(a){return this._layer=a,this._updateList(),this},_getPath:function(a,b){var c=b.split("."),d=c.pop(),e=c.length,f=c[0],g=1;if(e>0)for(;(a=a[f])&&e>g;)f=c[g++];return a?a[d]:void 0},_itemBuild:function(a){var b=L.DomUtil.create("a",""),c=this._getPath(a.feature,this.options.listLabel);return b.innerHTML="<span>"+(c||"&nbsp;")+"</span>",b},_createItem:function(a){var b=this,c=this._itemBuild.call(this,a);return L.DomUtil.addClass(c,"geojson-list-item"),a.itemList=c,L.DomEvent.disableClickPropagation(c).on(c,this.options.activeEventList,L.DomEvent.stop,this).on(c,this.options.activeEventList,function(c){b._moveTo(a),b.fire("item-active",{layer:a})},this).on(c,"mouseover",function(c){L.DomUtil.addClass(c.target,this.options.activeClass),a.setStyle&&a.setStyle(b.options.activeStyle)},this).on(c,"mouseout",function(c){L.DomUtil.removeClass(c.target,this.options.activeClass),a.setStyle&&a.setStyle(b.options.style)},this),c},_updateList:function(){var a=this,b=[],c=this.options.listSortBy;this._list.innerHTML="",this._layer.eachLayer(function(c){b.push(c),c.setStyle&&c.setStyle(a.options.style),a.options.activeListFromLayer&&c.on(a.options.activeEventList,L.DomEvent.stop).on(a.options.activeEventList,function(b){a.fire("item-active",{layer:c})}).on("mouseover",function(b){c.setStyle&&c.setStyle(a.options.activeStyle),L.DomUtil.addClass(c.itemList,a.options.activeClass)}).on("mouseout",function(b){c.setStyle&&c.setStyle(a.options.style),L.DomUtil.removeClass(c.itemList,a.options.activeClass)})}),b.sort(function(b,d){var e=a._getPath(b.feature,c),f=a._getPath(d.feature,c);return f>e?-1:e>f?1:0});for(var d=0;d<b.length;d++)this._list.appendChild(this._createItem(b[d]))},_initToggle:function(){var a=this._container;if(a.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(a),this.options.collapsed){this._collapse(),L.Browser.android||L.DomEvent.on(a,"mouseover",this._expand,this).on(a,"mouseout",this._collapse,this);var b=this._button=L.DomUtil.create("a","geojson-list-toggle",a);b.href="#",b.title="List GeoJSON",L.Browser.touch?L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",this._expand,this):L.DomEvent.on(b,"focus",this._expand,this),this._map.on("click",this._collapse,this)}},_expand:function(){this._container.className=this._container.className.replace(" geojson-list-collapsed","")},_collapse:function(){L.DomUtil.addClass(this._container,"geojson-list-collapsed")},_moveTo:function(a){a.getBounds?this._map.fitBounds(a.getBounds().pad(1)):a.getLatLng&&this._map.setView(a.getLatLng())}}),L.control.geoJsonSelector=function(a,b){return new L.Control.GeoJSONSelector(a,b)}}).call(this);